<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Phishing Detection</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Email Phishing Detection</h1>
        
        <!--email form-->
        <div class="container mt-5">
            <h1>Email Phishing Detection</h1>
            <form id="uploadForm" action="/test_email" method="POST" enctype="multipart/form-data">
                <div 
                    id="dragDropArea" 
                    class="drag-drop-area"
                    ondragover="event.preventDefault()" 
                    ondrop="handleDrop(event)"
                >
                    Drag and drop email file here (.html, .eml, or.txt) or click to browse
                </div>
                <input 
                    type="file" 
                    id="emailFileInput" 
                    name="email_file" 
                    accept=".txt,.html,.eml" 
                    class="hidden" 
                    onchange="handleFileSelect(event)"
                >
                <button type="submit" class="btn btn-primary mt-3" id="submitButton" disabled>Test Email</button>
            </form>
        </div>
    
        <script>
            const dragDropArea = document.getElementById('dragDropArea');
            const fileInput = document.getElementById('emailFileInput');
            const submitButton = document.getElementById('submitButton');
            let selectedFile = null;
    
            //handle drag/drop
            function handleDrop(event) {
                event.preventDefault();
                dragDropArea.classList.remove('dragging');
                const files = event.dataTransfer.files;
                if (files.length) {
                    processFile(files[0]);
                }
            }
    
            //highlight area drag
            dragDropArea.addEventListener('dragover', () => {
                dragDropArea.classList.add('dragging');
            });
    
            //rm highlight when dragging ends
            dragDropArea.addEventListener('dragleave', () => {
                dragDropArea.classList.remove('dragging');
            });
    
            //handle click to open file browser
            dragDropArea.addEventListener('click', () => {
                fileInput.click();
            });
    
            //handle file selection from browser
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    processFile(file);
                }
            }
    
            //process selected file
            function processFile(file) {
                const validTypes = ['text/plain', 'text/html', 'message/rfc822']; ;
                if (!validTypes.includes(file.type)) {
                    alert('Please upload a valid .txt, .eml or .html file.');
                    return;
                }
                selectedFile = file;
                dragDropArea.textContent = `File Selected: ${file.name}`;
                submitButton.disabled = false;
            }
    
            //make sure file submitted with form
            document.getElementById('uploadForm').addEventListener('submit', function(event) {
                if (!selectedFile) {
                    event.preventDefault();
                    alert('Please select a file before submitting.');
                    return;
                }
                //attach selected file to form
                const formData = new FormData(this);
                formData.set('email_file', selectedFile);
            });
        </script>

        <!-- results  -->
        <div id="results" class="mt-5" style="display: none;">
            <h3>Results</h3>
            <p><strong>Prediction:</strong> <span id="prediction"></span></p>
            <p><strong>Explanation:</strong></p>
            <ul id="explanation"></ul>
            <button class="btn btn-success" id="feedback-yes">This is correct</button>
            <button class="btn btn-danger" id="feedback-no">This is incorrect</button>
        </div>
    </div>

    <script>
        //handle form submission with AJAX
        $(document).ready(function () {
            $("#emailForm").on("submit", function (e) {
                e.preventDefault();

                const emailText = $("#email_text").val();
                if (!emailText) {
                    alert("Please enter email text.");
                    return;
                }

                //send email data to /upload_email endpoint
                $.ajax({
                    url: "/upload_email",
                    method: "POST",
                    data: { email_text: emailText },
                    success: function (response) {
                        //display prediction/explanation
                        $("#results").show();
                        $("#prediction").text(response.prediction);
                        
                        $("#explanation").empty();
                        for (const [key, value] of Object.entries(response.explanation)) {
                            $("#explanation").append(`<li>${key}: ${value}</li>`);
                        }
                    },
                    error: function () {
                        alert("Error processing the email. Please try again.");
                    }
                });
            });

            //handle feedback sub
            $("#feedback-yes").on("click", function () {
                submitFeedback(true);
            });

            $("#feedback-no").on("click", function () {
                submitFeedback(false);
            });

            function submitFeedback(isCorrect) {
                const feedback = {
                    email_text: $("#email_text").val(),
                    prediction: $("#prediction").text(),
                    correct: isCorrect
                };

                $.ajax({
                    url: "/feedback",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(feedback),
                    success: function () {
                        alert("Thank you for your feedback!");
                        $("#results").hide();
                        $("#emailForm")[0].reset();
                    },
                    error: function () {
                        alert("Error submitting feedback. Please try again.");
                    }
                });
            }
        });
    </script>
</body>
</html>