
<!-- trying a simpler html page for purpose of testing new rf model. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Email Detection</title>
    <style>
        /*style for collapsible section */
        .collapsible {
            background-color: #777;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        .active, .collapsible:hover {
            background-color: #555;
        }

        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <h1>Upload an Email for Phishing Detection</h1>

    <!--disply flash msgs -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul>
        {% for category, message in messages %}
          <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- form for upload email -->
    <form action="/" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" accept=".eml, .txt, .html" required>
        <button type="submit">Upload and Predict</button>
        <button type="submit" name="clear">Clear</button>  <!-- Clear button -->
    </form>

    <!--show prediction result -->
    {% if prediction_result %}
        <h3>{{ prediction_result }}</h3>
    {% endif %}

     <!--pred res -->
     <h2>Prediction: {{ prediction_result }}</h2>
    
     <!--confusion mtrx -->
     <h3>Confusion Matrix</h3>
     <img src="{{ url_for('static', filename='confusion_matrix.png') }}" alt="Confusion Matrix">
 
     <!--collapsible Section for TP, TN, FP, FN -->
     <button class="collapsible">Click to see detailed metrics</button>
     <div class="content">
         <h4>True Positives (TP) -- Bottom right:</h4>
         <p>The number of times the model correctly predicted a positive class (Phishing Email).</p>
         <h4>True Negatives (TN) -- Top Left:</h4>
         <p>The number of times the model correctly predicted a negative class (Legitimate Email).</p>
         <h4>False Positives (FP) -- Top right:</h4>
         <p>The number of times the model incorrectly predicted a positive class (Phishing Email, but it was legitimate).</p>
         <h4>False Negatives (FN) -- Bottom Left:</h4>
         <p>The number of times the model incorrectly predicted a negative class (Legitimate Email, but it was phishing).</p>
     </div>

     
 
     <script>
         // Js for the collapsible section
         var coll = document.getElementsByClassName("collapsible");
         for (var i = 0; i < coll.length; i++) {
             coll[i].addEventListener("click", function() {
                 this.classList.toggle("active");
                 var content = this.nextElementSibling;
                 if (content.style.display === "block") {
                     content.style.display = "none";
                 } else {
                     content.style.display = "block";
                 }
             });
         }
     </script>
</body>
</html>


















<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Phishing Detection</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='/styles.css') }}">
</head>
<body>
    <div class="container mt-5">
        
       
        <div class="container mt-5">
            <h1>Email Phishing Detection</h1>
            <form id="uploadForm" action="/test_email" method="POST" enctype="multipart/form-data">
                <div 
                    id="dragDropArea" 
                    class="drag-drop-area"
                    ondragover="event.preventDefault()" 
                    ondrop="handleDrop(event)"
                >
                    Drag and drop email file here (.html, .eml, or.txt) or click to browse
                </div>
                <input 
                    type="file" 
                    id="emailFileInput" 
                    name="email_file" 
                    accept=".txt,.html,.eml" 
                    class="hidden" 
                    onchange="handleFileSelect(event)"
                >
                <button type="submit" class="btn btn-primary mt-3" id="submitButton" disabled>Test Email</button>
            </form>
        </div>
    
        <script>
            const dragDropArea = document.getElementById('dragDropArea');
            const fileInput = document.getElementById('emailFileInput');
            const submitButton = document.getElementById('submitButton');
    
            $(document).ready(function () {
                let selectedFile = null;

            //handle drag/drop
            function handleDrop(event) {
                event.preventDefault();
                const files = event.dataTransfer.files;
                if (files.length) {
                    processFile(files[0]);
                }
            }
    
            //highlight area drag
            dragDropArea.addEventListener('dragover', () => {
                dragDropArea.classList.add('dragging');
            });
    
            //rm highlight when dragging ends
            dragDropArea.addEventListener('dragleave', () => {
                dragDropArea.classList.remove('dragging');
            });
    
            //handle click to open file browser
            dragDropArea.addEventListener('click', () => {
                fileInput.click();
            });
    
            //handle file selection from browser
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    processFile(file);
                }
            }
    
            //process selected file
            function processFile(file) {
                const validTypes = ['text/plain', 'text/html', 'message/rfc822']; ;
                if (!validTypes.includes(file.type)) {
                    alert('Please upload a valid .txt, .eml or .html file.');
                    return;
                }
                selectedFile = file;
                $('#dragDropArea').text(`File Selected: ${file.name}`);
                $('#submitButton').prop('disabled', false);
            }
            $("#uploadForm").on("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    if (!formData.get("email_file")) {
        alert('Please select a file before submitting.');
        return;
    }

    $("#toggle-matrix").on("click", function () {
        const matrixDiv = $("#confusion-matrix");
        const arrow = $("#matrix-arrow");

        if (matrixDiv.is(":visible")) {
            matrixDiv.slideUp(); // hide 
            arrow.text("▼");    // change arrow direction
        } else {
            matrixDiv.slideDown(); // show 
            arrow.text("▲");      // change arrow to up
        }
    });

    $.ajax({
        url: "/test_email",
        method: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
        //show results section
            $("#results").show();

            // Display prediction
            $("#prediction").text(response.prediction === 1 ? "Phishing" : "Not Phishing");

            // Display explanation
            $("#explanation").html(`<p>${response.explanation}</p>`);


            //Display confusion matrix as a table
            const matrix = response.confusion_matrix;
                const tableHtml = `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Predicted Non-Phishing</th>
                                <th>Predicted Phishing</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Actual Non-Phishing</td>
                                <td>${matrix[0][0]}</td>
                                <td>${matrix[0][1]}</td>
                            </tr>
                            <tr>
                                <td>Actual Phishing</td>
                                <td>${matrix[1][0]}</td>
                                <td>${matrix[1][1]}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                $("#confusion-matrix").html(tableHtml);
            },
            error: function () {
                alert("Error processing the email. Please try again.");
            }
    });
});

        



    //handle drag events
    $('#dragDropArea').on('dragover', function () {
        $(this).addClass('dragging');
    });

    $('#dragDropArea').on('dragleave', function () {
        $(this).removeClass('dragging');
    });

    $('#dragDropArea').on('click', function () {
        $('#emailFileInput').click();
    });

    $('#emailFileInput').on('change', handleFileSelect);
});
console.log(selectedFile);
        </script>

        results 
        <div id="results" class="mt-5" style="display: none;">
            <h3>Results</h3>
            <p><strong>Prediction:</strong> <span id="prediction"></span></p>
            <p><strong>Explanation:</strong></p>
            <h4>Confusion Matrix
            <button id="toggle-matrix" class="btn btn-link">
                <span id="matrix-arrow">▼</span>
            </button>
            </h4>
            <div id="confusion-matrix" class="mt-3" style="display: none;""></div>


            <ul id="explanation"></ul>
            <button class="btn btn-success" id="feedback-yes">This is correct</button>
            <button class="btn btn-danger" id="feedback-no">This is incorrect</button>
        </div>
    </div>


    <script>
        //handle form submission with AJAX
        $(document).ready(function () {
            
                 

            $("#emailForm").on("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this); // create FormData object fo rfile data

                    // check if file selected otherwise alert.
                 if (!formData.get("email_file")) {
                    alert("Please select a file before submitting.");
                    return;
        }

                //send email data to /upload_email endpoint
                $.ajax({
                    url: "/upload_email",
                    method: "POST",
                    data: formData,
                    contentType: false, //do not set content type, FormData will handle it
                    processData: false, 
                    success: function (response) {
                        //display
                        $("#results").show();
                        $("#prediction").text(response.prediction);
                        $("#explanation").empty();
                        for (const [key, value] of Object.entries(response.explanation)) {
                            $("#explanation").append(`<li>${key}: ${value}</li>`);
                        }
                    },
                    error: function () {
                        alert("Error processing the email. Please try again.");
                    }
                });
            });

           
            //handle feedback sub
            $("#feedback-yes").on("click", function () {
                submitFeedback(true);
            });

            $("#feedback-no").on("click", function () {
                submitFeedback(false);
            });

            function submitFeedback(isCorrect) {
                const feedback = {
                    email_text: $("#email_text").val(),
                    prediction: $("#prediction").text(),
                    correct: isCorrect
                };

                $.ajax({
                    url: "/feedback",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(feedback),
                    success: function () {
                        alert("Thank you for your feedback!");
                        $("#results").hide();
                        $("#uploadForm")[0].reset();
                    },
                    error: function () {
                        alert("Error submitting feedback. Please try again.");
                    }
                });
            }
        });
    </script>

    
</body>
</html>
-->